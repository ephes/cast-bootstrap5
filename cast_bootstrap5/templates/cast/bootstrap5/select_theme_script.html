{% load i18n %}
<script>
  (function() {
    'use strict';

    var STORAGE_KEY = 'cast-theme';
    var INIT_KEY = '__castThemeSwitchInit';
    var LABELS = {
      auto: '{% trans "System" as system_label %}{{ system_label|escapejs }}',
      light: '{% trans "Light" as light_label %}{{ light_label|escapejs }}',
      dark: '{% trans "Dark" as dark_label %}{{ dark_label|escapejs }}'
    };

    function getStoredTheme() {
      try { return localStorage.getItem(STORAGE_KEY); } catch (e) { return null; }
    }

    function setStoredTheme(theme) {
      try { localStorage.setItem(STORAGE_KEY, theme); } catch (e) { /* ignore */ }
    }

    function getActualTheme(theme) {
      if (theme === 'auto') {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      return theme;
    }

    function setTheme(theme) {
      var actualTheme = getActualTheme(theme);
      document.documentElement.setAttribute('data-bs-theme', actualTheme);
    }

    function syncSwitch(switcher) {
      if (!switcher) {
        return;
      }
      var storedTheme = getStoredTheme() || 'auto';
      var label = switcher.querySelector('[data-cast-theme-label]');
      if (label && LABELS[storedTheme]) {
        label.textContent = LABELS[storedTheme];
      }
      var icons = switcher.querySelectorAll('[data-cast-theme-icon]');
      icons.forEach(function(icon) {
        var iconTheme = icon.getAttribute('data-cast-theme-icon');
        icon.style.display = iconTheme === storedTheme ? 'inline-flex' : 'none';
      });
      var modeButtons = switcher.querySelectorAll('[data-cast-theme-mode]');
      modeButtons.forEach(function(button) {
        var mode = button.getAttribute('data-cast-theme-mode');
        var active = mode === storedTheme;
        button.classList.toggle('active', active);
        button.setAttribute('aria-pressed', active ? 'true' : 'false');
        var check = button.querySelector('.cast-theme-check');
        if (check) {
          check.style.opacity = active ? '1' : '0';
        }
      });
    }

    function handleSelection(target) {
      var value = target.getAttribute('data-cast-theme-value');
      if (!value) {
        return;
      }
      if (value.indexOf('mode:') === 0) {
        var mode = value.replace('mode:', '');
        setStoredTheme(mode);
        setTheme(mode);
        syncAll(document);
        return;
      }
      if (value.indexOf('theme:') === 0) {
        var theme = value.replace('theme:', '');
        var form = target.closest('form');
        if (!form) {
          return;
        }
        var hidden = form.querySelector('input[name="template_base_dir"]');
        if (hidden) {
          hidden.value = theme;
        }
        form.submit();
      }
    }

    function syncAll(root) {
      var scope = root || document;
      var switchers = scope.querySelectorAll('[data-cast-theme-switcher]');
      switchers.forEach(function(switcher) {
        syncSwitch(switcher);
      });
    }

    function setupEventListeners() {
      if (window[INIT_KEY]) {
        return;
      }
      window[INIT_KEY] = true;

      document.body.addEventListener('click', function(event) {
        var target = event.target.closest('[data-cast-theme-value]');
        if (target) {
          event.preventDefault();
          handleSelection(target);
        }
      });

      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        var storedTheme = getStoredTheme();
        if (!storedTheme || storedTheme === 'auto') {
          setTheme('auto');
          syncAll(document);
        }
      });

      document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.querySelector && event.detail.target.querySelector('[data-cast-theme-switcher]')) {
          syncAll(event.detail.target);
        }
      });
    }

    syncAll(document);
    setupEventListeners();
  })();
</script>
