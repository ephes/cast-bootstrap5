{% load i18n %}
<li class="nav-item theme-selector">
  <form action="{% url "cast:select-theme" %}" method="post" class="d-flex align-items-center gap-2">
    {% csrf_token %}
    <input type="hidden" name="template_base_dir" value="{{ template_base_dir }}">
    <input type="hidden" name="next" value="{{ next_url }}">
    <label class="visually-hidden" for="cast-theme-select">{% trans "Theme" %}</label>
    <select id="cast-theme-select" class="form-select form-select-sm cast-theme-select" data-cast-theme-select>
      <optgroup label="{% trans "Color mode" %}">
        <option value="mode:auto">{% trans "System" %}</option>
        <option value="mode:light">{% trans "Light" %}</option>
        <option value="mode:dark">{% trans "Dark" %}</option>
      </optgroup>
      {% if template_base_dir_choices|length > 1 %}
        <optgroup label="{% trans "Theme" %}">
          {% for theme_slug, theme_name in template_base_dir_choices %}
            <option value="theme:{{ theme_slug }}">{{ theme_name }}</option>
          {% endfor %}
        </optgroup>
      {% endif %}
    </select>
  </form>
</li>

<script>
  (function() {
    'use strict';

    var STORAGE_KEY = 'cast-theme';
    var INIT_KEY = '__castThemeSelectInit';

    function getStoredTheme() {
      try { return localStorage.getItem(STORAGE_KEY); } catch (e) { return null; }
    }

    function setStoredTheme(theme) {
      try { localStorage.setItem(STORAGE_KEY, theme); } catch (e) { /* ignore */ }
    }

    function getActualTheme(theme) {
      if (theme === 'auto') {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      return theme;
    }

    function setTheme(theme) {
      var actualTheme = getActualTheme(theme);
      document.documentElement.setAttribute('data-bs-theme', actualTheme);
    }

    function syncSelect(select) {
      if (!select) {
        return;
      }
      var storedTheme = getStoredTheme();
      var value = storedTheme ? 'mode:' + storedTheme : 'mode:auto';
      if (select.querySelector('option[value="' + value + '"]')) {
        select.value = value;
      }
    }

    function handleSelect(select) {
      var value = select.value;
      if (!value) {
        return;
      }
      if (value.indexOf('mode:') === 0) {
        var mode = value.replace('mode:', '');
        setStoredTheme(mode);
        setTheme(mode);
        return;
      }
      if (value.indexOf('theme:') === 0) {
        var theme = value.replace('theme:', '');
        var form = select.closest('form');
        if (!form) {
          return;
        }
        var hidden = form.querySelector('input[name="template_base_dir"]');
        if (hidden) {
          hidden.value = theme;
        }
        form.submit();
      }
    }

    function initSelectors(root) {
      var scope = root || document;
      var selects = scope.querySelectorAll('[data-cast-theme-select]');
      selects.forEach(function(select) {
        syncSelect(select);
      });
    }

    function setupEventListeners() {
      if (window[INIT_KEY]) {
        return;
      }
      window[INIT_KEY] = true;

      document.body.addEventListener('change', function(event) {
        var select = event.target.closest('[data-cast-theme-select]');
        if (select) {
          handleSelect(select);
        }
      });

      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        var storedTheme = getStoredTheme();
        if (!storedTheme || storedTheme === 'auto') {
          setTheme('auto');
          initSelectors(document);
        }
      });

      document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.querySelector && event.detail.target.querySelector('[data-cast-theme-select]')) {
          initSelectors(event.detail.target);
        }
      });
    }

    initSelectors(document);
    setupEventListeners();
  })();
</script>
