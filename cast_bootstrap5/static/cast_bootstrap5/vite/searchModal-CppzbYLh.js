var D=Object.defineProperty;var U=(r,a,e)=>a in r?D(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e;var c=(r,a,e)=>U(r,typeof a!="symbol"?a+"":a,e);var O=(r,a,e)=>new Promise((t,s)=>{var i=o=>{try{n(e.next(o))}catch(u){s(u)}},l=o=>{try{n(e.throw(o))}catch(u){s(u)}},n=o=>o.done?t(o.value):Promise.resolve(o.value).then(i,l);n((e=e.apply(r,a)).next())});const P=['input:not([disabled]):not([type="hidden"])',"button:not([disabled])","select:not([disabled])","a[href]","details > summary",'[tabindex]:not([tabindex="-1"])'].join(", ");function K(r){return r.offsetParent!==null}function H(r){let a=!1;const e=t=>{if(!a||t.key!=="Tab")return;const s=Array.from(r.querySelectorAll(P)).filter(n=>K(n));if(s.length===0)return;const i=s[0],l=s[s.length-1];if(t.shiftKey&&document.activeElement===i){t.preventDefault(),l.focus();return}!t.shiftKey&&document.activeElement===l&&(t.preventDefault(),i.focus())};return{activate(){a||(r.addEventListener("keydown",e),a=!0)},deactivate(){a&&(r.removeEventListener("keydown",e),a=!1)}}}const N="[data-cast-search-trigger]",L="-visible_date",G=150,V=50,S=["date_facets","tag_facets","category_facets"],x="All";function $(r){const a=[];return r instanceof Element&&r.id==="div_id_o"&&a.push(r),a.push(...Array.from(r.querySelectorAll("#div_id_o"))),a}function F(r){return r!==null&&S.includes(r)}function z(r){const a=r.closest("[data-cast-filter-panel]"),e=a==null?void 0:a.getAttribute("data-cast-filter-panel");return!e||e==="o"?null:e}function A(r){const a=r.getAttribute("data-cast-facet-group");if(F(a))return a;const e=z(r);return F(e)?e:null}function B(r,a){var s;const e=r.querySelector(`[data-cast-facet-group="${a}"]`);if(e)return e;const t=r.querySelector(`[data-cast-filter-panel="${a}"]`);return(s=t==null?void 0:t.querySelector("[data-cast-facet-group]"))!=null?s:null}function j(r){$(r).forEach(a=>{if(a.dataset.castOrderingPills==="true")return;const e=a.querySelector('select[name="o"]');if(!e)return;const t=document.createElement("div");t.className="cast-ordering-pills",Array.from(e.options).forEach(s=>{if(!s.value)return;const i=document.createElement("button");i.type="button",i.className="tag-pill",i.textContent=s.textContent,i.setAttribute("data-order-value",s.value),s.selected&&s.value!==""||e.value===""&&s.value===L?(i.classList.add("active"),i.setAttribute("aria-pressed","true"),e.value=s.value):i.setAttribute("aria-pressed","false"),i.addEventListener("click",()=>{e.value=s.value,t.querySelectorAll(".tag-pill").forEach(n=>{n.classList.remove("active"),n.setAttribute("aria-pressed","false")}),i.classList.add("active"),i.setAttribute("aria-pressed","true")}),t.appendChild(i)}),t.children.length>0&&(e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true"),e.style.display="none",a.appendChild(t),a.dataset.castOrderingPills="true")})}function M(r){r.querySelectorAll("[data-cast-facet-group]").forEach(a=>{var l,n;if(a.dataset.castFacetToggleReady==="true")return;const e=Number.parseInt((l=a.dataset.limit)!=null?l:"12",10),t=Array.from(a.querySelectorAll(".cast-date-facet-item, .tag-pill"));if(!Number.isFinite(e)||t.length<=e){a.dataset.castFacetToggleReady="true";return}const s=(n=a.parentElement)==null?void 0:n.querySelector("[data-cast-facet-toggle]");if(!s){a.dataset.castFacetToggleReady="true";return}const i=o=>{t.forEach((h,f)=>{h.hidden=!o&&f>=e}),s.setAttribute("aria-expanded",String(o));const u=s.querySelector("[data-show-text]"),d=s.querySelector("[data-hide-text]");u&&(u.hidden=o),d&&(d.hidden=!o)};s.hidden=!1,i(!1),s.addEventListener("click",()=>{const o=s.getAttribute("aria-expanded")==="true";i(!o)}),a.dataset.castFacetToggleReady="true"})}function W(r){return r instanceof HTMLElement?r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable:!1}function g(r,a){var t;const e=r.getAttribute("href");if(!e)return"";try{return(t=new URL(e,window.location.href).searchParams.get(a))!=null?t:""}catch(s){return""}}function _(r,a){return Array.from(r.querySelectorAll('input[type="hidden"]')).filter(e=>e.name===a)}function E(r,a,e){if(_(r,a).forEach(s=>s.remove()),!e)return;const t=document.createElement("input");t.type="hidden",t.name=a,t.value=e,t.setAttribute("data-cast-facet-hidden","true"),r.appendChild(t)}function X(r){if(!r||typeof r!="object")return!1;const a=r;return a.mode==="modal"&&typeof a.result_count=="number"&&!!a.groups}function Y(){return{date_facets:"",tag_facets:"",category_facets:""}}function J(r){const a=new Set;return r.filter(e=>a.has(e.slug)?!1:(a.add(e.slug),!0))}class T extends HTMLElement{constructor(){super();c(this,"trigger");c(this,"overlay");c(this,"modal");c(this,"modalBody");c(this,"closeButton");c(this,"searchInput");c(this,"form");c(this,"loadingElement");c(this,"statusElement");c(this,"noResultsElement");c(this,"submitButton");c(this,"dynamicFacetsUrl");c(this,"focusTrap");c(this,"listenersBound");c(this,"state");c(this,"boundTriggerClick");c(this,"boundOverlayClick");c(this,"boundCloseClick");c(this,"boundDocumentKeydown");c(this,"boundModalClick");c(this,"boundSearchInput");this.trigger=null,this.overlay=null,this.modal=null,this.modalBody=null,this.closeButton=null,this.searchInput=null,this.form=null,this.loadingElement=null,this.statusElement=null,this.noResultsElement=null,this.submitButton=null,this.dynamicFacetsUrl=null,this.focusTrap=null,this.listenersBound=!1,this.state={selected:Y(),search:"",ordering:"",inFlight:null,requestSeq:0,appliedSeq:0,debounceTimer:null,loadingTimer:null,cache:new Map},this.boundTriggerClick=this.openModal.bind(this),this.boundOverlayClick=this.handleOverlayClick.bind(this),this.boundCloseClick=this.closeModal.bind(this),this.boundDocumentKeydown=this.handleDocumentKeydown.bind(this),this.boundModalClick=this.handleModalClick.bind(this),this.boundSearchInput=this.handleSearchInput.bind(this)}static register(e="cast-search-modal"){"customElements"in window&&(customElements.get(e)||customElements.define(e,T))}connectedCallback(){this.resolveElements(),!(!this.overlay||!this.modal)&&(this.focusTrap=H(this.modal),M(this.modal),j(this.modal),this.initializeFacetInputsFromSelection(),this.captureStateFromForm(),this.markAllFacetLinks(),this.expandActivePanels(),this.bindListeners())}disconnectedCallback(){var e;this.overlay&&!this.overlay.hidden&&(this.overlay.hidden=!0,document.body.style.overflow=""),this.clearDebounceTimer(),this.clearLoadingTimer(),this.abortInFlightRequest(),this.setLoading(!1),this.unbindListeners(),(e=this.focusTrap)==null||e.deactivate(),this.focusTrap=null}openModal(){var e,t;this.overlay&&(this.overlay.hidden=!1,document.body.style.overflow="hidden",(e=this.focusTrap)==null||e.activate(),(t=this.searchInput)==null||t.focus())}closeModal(){var e,t;this.overlay&&(this.overlay.hidden=!0,document.body.style.overflow="",(e=this.focusTrap)==null||e.deactivate(),(t=this.trigger)==null||t.focus())}resolveElements(){var t,s,i,l,n,o,u,d,h,f,y,p,b,m,v,q,C,k,R,w,I;const e=(t=this.getAttribute("data-trigger"))!=null?t:N;this.trigger=document.querySelector(e),this.overlay=this.querySelector("[data-cast-search-overlay]"),this.modal=(i=(s=this.overlay)==null?void 0:s.querySelector(".cast-search-modal"))!=null?i:null,this.modalBody=(n=(l=this.overlay)==null?void 0:l.querySelector(".cast-search-modal-body"))!=null?n:null,this.closeButton=(u=(o=this.overlay)==null?void 0:o.querySelector("[data-cast-search-close]"))!=null?u:null,this.searchInput=(h=(d=this.overlay)==null?void 0:d.querySelector('input[name="search"]'))!=null?h:null,this.form=(b=(p=(f=this.overlay)==null?void 0:f.querySelector("form[data-cast-search-form]"))!=null?p:(y=this.overlay)==null?void 0:y.querySelector("form"))!=null?b:null,this.loadingElement=(v=(m=this.overlay)==null?void 0:m.querySelector("[data-cast-facet-loading]"))!=null?v:null,this.statusElement=(C=(q=this.overlay)==null?void 0:q.querySelector("[data-cast-facet-status]"))!=null?C:null,this.noResultsElement=(R=(k=this.overlay)==null?void 0:k.querySelector("[data-cast-no-results]"))!=null?R:null,this.submitButton=(I=(w=this.form)==null?void 0:w.querySelector('button[type="submit"]'))!=null?I:null,this.dynamicFacetsUrl=this.getAttribute("data-cast-dynamic-facets-url")}bindListeners(){var e,t,s,i,l,n;this.listenersBound||((e=this.trigger)==null||e.addEventListener("click",this.boundTriggerClick),(t=this.overlay)==null||t.addEventListener("click",this.boundOverlayClick),(s=this.closeButton)==null||s.addEventListener("click",this.boundCloseClick),(i=this.modal)==null||i.addEventListener("click",this.boundModalClick),(l=this.searchInput)==null||l.addEventListener("input",this.boundSearchInput),(n=this.searchInput)==null||n.addEventListener("search",this.boundSearchInput),document.addEventListener("keydown",this.boundDocumentKeydown),this.listenersBound=!0)}unbindListeners(){var e,t,s,i,l,n;this.listenersBound&&((e=this.trigger)==null||e.removeEventListener("click",this.boundTriggerClick),(t=this.overlay)==null||t.removeEventListener("click",this.boundOverlayClick),(s=this.closeButton)==null||s.removeEventListener("click",this.boundCloseClick),(i=this.modal)==null||i.removeEventListener("click",this.boundModalClick),(l=this.searchInput)==null||l.removeEventListener("input",this.boundSearchInput),(n=this.searchInput)==null||n.removeEventListener("search",this.boundSearchInput),document.removeEventListener("keydown",this.boundDocumentKeydown),this.listenersBound=!1)}handleOverlayClick(e){e.target===this.overlay&&this.closeModal()}handleDocumentKeydown(e){if(this.overlay){if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==="k"){if(W(document.activeElement))return;e.preventDefault(),this.overlay.hidden?this.openModal():this.closeModal();return}e.key==="Escape"&&!this.overlay.hidden&&(e.preventDefault(),this.closeModal())}}handleSearchInput(){var e,t;this.state.search=(t=(e=this.searchInput)==null?void 0:e.value)!=null?t:"",this.state.ordering=this.getOrderingValue(),this.scheduleFacetRecalculation()}handleModalClick(e){var d,h;if(!this.modal||!this.form)return;const t=e.target;if(!(t instanceof Element))return;const s=t.closest(".cast-btn-clear");if(s&&this.modal.contains(s)){e.preventDefault(),this.clearAllFilters();return}const i=t.closest("[data-cast-facet-group] a[href]");if(!i||!this.modal.contains(i))return;if(i.getAttribute("aria-disabled")==="true"||i.classList.contains("is-disabled")){e.preventDefault();return}const l=i.closest("[data-cast-facet-group]");if(!l)return;const n=A(l);if(!n)return;e.preventDefault(),l.querySelectorAll("a.selected").forEach(f=>{f.classList.remove("selected")}),i.classList.add("selected");const o=g(i,n);this.state.selected[n]=o,E(this.form,n,o);const u=l.closest("details");u&&(u.open=!0),this.state.search=(h=(d=this.searchInput)==null?void 0:d.value)!=null?h:"",this.state.ordering=this.getOrderingValue(),this.scheduleFacetRecalculation()}clearAllFilters(){if(!this.modal||!this.form)return;this.searchInput&&(this.searchInput.value=""),this.state.search="",S.forEach(t=>{this.state.selected[t]="",E(this.form,t,"");const s=B(this.modal,t);if(!s)return;const i=Array.from(s.querySelectorAll("a[href]"));i.forEach(n=>n.classList.remove("selected"));const l=i.find(n=>g(n,t)==="");l==null||l.classList.add("selected")});const e=this.form.querySelector('select[name="o"]');e?(e.querySelector(`option[value="${L}"]`)?e.value=L:e.options.length>0?e.value=e.options[0].value:e.value="",this.state.ordering=e.value,this.syncOrderingPills(e.value)):this.state.ordering="",this.applyNoResultsState(1),this.markAllFacetLinks(),this.expandActivePanels(),this.announceStatus("Filters cleared."),this.scheduleFacetRecalculation()}syncOrderingPills(e){this.modal&&this.modal.querySelectorAll(".cast-ordering-pills .tag-pill").forEach(t=>{const s=t.getAttribute("data-order-value")===e;t.classList.toggle("active",s),t.setAttribute("aria-pressed",s?"true":"false")})}initializeFacetInputsFromSelection(){!this.modal||!this.form||this.modal.querySelectorAll("[data-cast-facet-group]").forEach(e=>{const t=A(e);if(!t)return;const s=e.querySelector("a.selected[href]");if(!s){this.state.selected[t]="",E(this.form,t,"");return}const i=g(s,t);this.state.selected[t]=i,E(this.form,t,i)})}captureStateFromForm(){var e,t;this.state.search=(t=(e=this.searchInput)==null?void 0:e.value)!=null?t:"",this.state.ordering=this.getOrderingValue()}scheduleFacetRecalculation(){this.dynamicFacetsUrl&&(this.clearDebounceTimer(),this.state.debounceTimer=setTimeout(()=>{this.refreshDynamicFacets()},G))}clearDebounceTimer(){this.state.debounceTimer!==null&&(clearTimeout(this.state.debounceTimer),this.state.debounceTimer=null)}clearLoadingTimer(){this.state.loadingTimer!==null&&(clearTimeout(this.state.loadingTimer),this.state.loadingTimer=null)}abortInFlightRequest(){var e;(e=this.state.inFlight)==null||e.abort(),this.state.inFlight=null}refreshDynamicFacets(){return O(this,null,function*(){if(!this.dynamicFacetsUrl)return;const e=++this.state.requestSeq,t=this.buildRequestKey();this.abortInFlightRequest();const s=this.state.cache.get(t);if(s){this.state.appliedSeq=e,this.setLoading(!1),this.applyFacetResponse(s),this.announceStatus("Filters updated.");return}const i=new AbortController;this.state.inFlight=i,this.setLoading(!0);try{const l=this.buildRequestUrl(),n=yield fetch(l.toString(),{signal:i.signal});if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=yield n.json();if(!X(o))throw new Error("Invalid modal facet response");if(this.setCacheEntry(t,o),e<this.state.appliedSeq)return;this.state.appliedSeq=e,this.applyFacetResponse(o),this.announceStatus("Filters updated.")}catch(l){if(l instanceof DOMException&&l.name==="AbortError")return;this.setSubmitEnabled(!0),this.noResultsElement&&(this.noResultsElement.hidden=!0),this.announceStatus("Could not refresh filters. You can still search.")}finally{this.state.inFlight===i&&(this.state.inFlight=null,this.setLoading(!1))}})}buildRequestUrl(){var s;const e=new URL((s=this.dynamicFacetsUrl)!=null?s:"",window.location.href),t=this.buildRequestParams(!0);return e.search=t.toString(),e}buildRequestKey(){return this.buildRequestParams(!1).toString()}buildRequestParams(e){const t=new URLSearchParams;return t.set("mode","modal"),this.state.search&&t.set("search",this.state.search),S.forEach(s=>{const i=this.state.selected[s];i&&t.set(s,i)}),e&&this.state.ordering&&t.set("o",this.state.ordering),t}setCacheEntry(e,t){if(this.state.cache.delete(e),this.state.cache.set(e,t),this.state.cache.size<=V)return;const s=this.state.cache.keys().next().value;s!==void 0&&this.state.cache.delete(s)}getOrderingValue(){if(!this.form)return"";const e=this.form.querySelector('select[name="o"]');return e?e.value:""}applyFacetResponse(e){!this.modal||!this.form||(Object.entries(e.groups).forEach(([t,s])=>{var i;!F(t)||!s||(this.state.selected[t]=(i=s.selected)!=null?i:"",this.renderFacetGroup(t,s))}),this.syncHiddenInputsFromState(),this.markAllFacetLinks(),M(this.modal),this.expandActivePanels(),this.applyNoResultsState(e.result_count))}renderFacetGroup(e,t){var p,b;if(!this.modal||!this.form)return;const s=B(this.modal,e);if(!s)return;const i=s.closest("details"),l=(p=i==null?void 0:i.open)!=null?p:!1,n=this.getAllLabel(s,e),o=s.querySelector(".cast-date-facet-container"),u=(b=o==null?void 0:o.className)!=null?b:"cast-date-facet-container",d=document.createDocumentFragment(),h=this.createFacetOptionItem({groupName:e,slug:"",name:n,count:t.all_count,selected:t.selected===""});h&&d.appendChild(h),this.orderOptionsByCurrentDom(e,s,J(t.options)).forEach(m=>{const v=this.createFacetOptionItem({groupName:e,slug:m.slug,name:m.name,count:m.count,selected:m.slug===t.selected});v&&d.appendChild(v)});const y=document.createElement("div");y.className=u,y.appendChild(d),s.replaceChildren(y),this.resetFacetToggleForGroup(s),i&&(i.open=l)}createFacetOptionItem({groupName:e,slug:t,name:s,count:i,selected:l}){if(t!==""&&i===0&&!l)return null;const n=document.createElement("div");n.className="cast-date-facet-item";const o=document.createElement("a");return o.href=this.buildFacetHref(e,t),o.textContent=`${s} (${i})`,t===""&&o.classList.add("cast-facet-all-option"),l&&o.classList.add("selected"),n.appendChild(o),n}markAllFacetLinks(){this.modal&&this.modal.querySelectorAll("[data-cast-facet-group]").forEach(e=>{const t=A(e);t&&e.querySelectorAll("a[href]").forEach(s=>{g(s,t)===""&&s.classList.add("cast-facet-all-option")})})}orderOptionsByCurrentDom(e,t,s){const i=new Map;let l=0;return t.querySelectorAll("a[href]").forEach(n=>{const o=g(n,e);!o||i.has(o)||(i.set(o,l),l+=1)}),i.size===0?s:[...s].sort((n,o)=>{const u=i.get(n.slug),d=i.get(o.slug);return u!==void 0&&d!==void 0?u-d:u!==void 0?-1:d!==void 0?1:0})}buildFacetHref(e,t){if(!this.form)return"#";const s=new URL(this.form.action,window.location.href),i=new URLSearchParams;this.state.search&&i.set("search",this.state.search),S.forEach(n=>{const o=n===e?t:this.state.selected[n];o&&i.set(n,o)}),this.state.ordering&&i.set("o",this.state.ordering);const l=i.toString();return l?`${s.pathname}?${l}`:s.pathname}resetFacetToggleForGroup(e){var n;e.dataset.castFacetToggleReady="";const t=(n=e.parentElement)==null?void 0:n.querySelector("[data-cast-facet-toggle]");if(!t)return;const s=t.cloneNode(!0);s.hidden=!0,s.removeAttribute("aria-expanded");const i=s.querySelector("[data-show-text]"),l=s.querySelector("[data-hide-text]");i&&(i.hidden=!1),l&&(l.hidden=!0),t.replaceWith(s)}syncHiddenInputsFromState(){this.form&&S.forEach(e=>{E(this.form,e,this.state.selected[e])})}getAllLabel(e,t){const i=Array.from(e.querySelectorAll("a[href]")).find(o=>g(o,t)==="");if(!(i!=null&&i.textContent))return x;const[l]=i.textContent.split("(");return l.trim()||x}applyNoResultsState(e){const t=e>0;this.noResultsElement&&(this.noResultsElement.hidden=t),this.setSubmitEnabled(t)}setSubmitEnabled(e){this.submitButton&&(this.submitButton.disabled=!e)}setLoading(e){this.modalBody&&(e?this.modalBody.setAttribute("aria-busy","true"):this.modalBody.removeAttribute("aria-busy")),this.loadingElement&&(e?(this.clearLoadingTimer(),this.state.loadingTimer=setTimeout(()=>{this.loadingElement&&(this.loadingElement.hidden=!1),this.state.loadingTimer=null},180)):(this.clearLoadingTimer(),this.loadingElement.hidden=!0))}announceStatus(e){this.statusElement&&(this.statusElement.textContent=e)}expandActivePanels(){!this.modal||!this.form||this.modal.querySelectorAll("[data-cast-filter-panel]").forEach(e=>{if(!(e instanceof HTMLDetailsElement))return;const t=e.getAttribute("data-cast-filter-panel");if(!F(t))return;_(this.form,t).some(i=>i.value!=="")&&(e.open=!0)})}}T.register("cast-search-modal");
